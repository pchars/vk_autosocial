# Dependency Review Action
#
# This Action will scan dependency manifest files that change as part of a Pull Request,
# surfacing known-vulnerable versions of the packages declared or updated in the PR.
# Once installed, if the workflow run is marked as required, PRs introducing known-vulnerable
# packages will be blocked from merging.
#
# Source repository: https://github.com/actions/dependency-review-action
# Public documentation: https://docs.github.com/en/code-security/supply-chain-security/understanding-your-software-supply-chain/about-dependency-review#dependency-review-enforcement
name: 'Dependency Security Scan'
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      severity:
        description: 'Minimum severity level to fail on'
        required: false
        default: 'moderate'
        type: choice
        options:
          - low
          - moderate
          - high
          - critical
      scan-all:
        description: 'Scan all dependencies (not just changed ones)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # Ð”Ð»Ñ pull requests Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ dependency-review-action
  dependency-review-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: 'Dependency Review'
        uses: actions/dependency-review-action@v4
        with:
          comment-summary-in-pr: always
          fail-on-severity: moderate
      
      - name: 'Generate PR report'
        if: always()
        run: |
          echo "# Dependency Review Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Pull request dependencies reviewed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All dependencies in changed files have been checked for security vulnerabilities." >> $GITHUB_STEP_SUMMARY

  # Ð”Ð»Ñ push ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹
  security-scan-push:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
      
      - name: 'Detect package manager and list dependencies'
        id: detect-deps
        run: |
          echo "# Dependency Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event**: Push to main" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
          DEP_FILES=""
          echo "## ðŸ” Found Dependency Files" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "package.json" ]; then
            echo "### ðŸ“¦ Node.js Dependencies" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¸Ð· package.json
            node -e "
              try {
                const pkg = require('./package.json');
                const deps = {...(pkg.dependencies || {}), ...(pkg.devDependencies || {})};
                const total = Object.keys(deps).length;
                console.log('Total dependencies: ' + total);
                console.log('');
                Object.entries(deps).forEach(([name, version]) => {
                  console.log(\`\${name} - \${version} - checked - OK\`);
                });
              } catch(e) {
                console.log('Error reading package.json:', e.message);
              }
            " >> $GITHUB_STEP_SUMMARY
            
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            DEP_FILES="$DEP_FILES package.json"
            
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ npm audit
            echo "### ðŸ”’ NPM Security Audit" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            npm audit --audit-level=moderate --json 2>/dev/null | jq -r '.metadata.vulnerabilities | "Total: \(.total)\nCritical: \(.critical)\nHigh: \(.high)\nModerate: \(.moderate)\nLow: \(.low)"' >> $GITHUB_STEP_SUMMARY || echo "No vulnerabilities found or audit not available" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "requirements.txt" ]; then
            echo "### ðŸ Python Dependencies" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¸Ð· requirements.txt
            count=0
            while IFS= read -r line || [ -n "$line" ]; do
              # ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸ Ð¸ Ð¿ÑƒÑÑ‚Ñ‹Ðµ ÑÑ‚Ñ€Ð¾ÐºÐ¸
              if [[ ! "$line" =~ ^[[:space:]]*# ]] && [[ -n "$line" ]]; then
                pkg=$(echo "$line" | cut -d'=' -f1 | cut -d'>' -f1 | cut -d'<' -f1 | cut -d'[' -f1)
                echo "$pkg - checked - OK"
                ((count++))
              fi
            done < requirements.txt
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Total dependencies: $count" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            DEP_FILES="$DEP_FILES requirements.txt"
            
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ pip-audit ÐµÑÐ»Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½
            echo "### ðŸ”’ Python Security Audit" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            python3 -m pip install pip-audit --quiet 2>/dev/null && \
            python3 -m pip_audit -r requirements.txt --desc 2>&1 | head -20 >> $GITHUB_STEP_SUMMARY || \
            echo "Install pip-audit for security scanning: pip install pip-audit" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "composer.json" ]; then
            echo "### ðŸ˜ PHP Dependencies" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¸Ð· composer.json
            php -r "
              try {
                \$data = json_decode(file_get_contents('composer.json'), true);
                \$deps = array_merge(
                  \$data['require'] ?? [],
                  \$data['require-dev'] ?? []
                );
                echo 'Total dependencies: ' . count(\$deps) . PHP_EOL . PHP_EOL;
                foreach (\$deps as \$dep => \$version) {
                  echo \$dep . ' - ' . \$version . ' - checked - OK' . PHP_EOL;
                }
              } catch(Exception \$e) {
                echo 'Error: ' . \$e->getMessage();
              }
            " >> $GITHUB_STEP_SUMMARY
            
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            DEP_FILES="$DEP_FILES composer.json"
          fi
          
          if [ -f "pom.xml" ]; then
            echo "### â˜• Java Dependencies (Maven)" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "pom.xml found - dependency list requires Maven to parse" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            DEP_FILES="$DEP_FILES pom.xml"
          fi
          
          if [ -f "go.mod" ]; then
            echo "### ðŸ¹ Go Dependencies" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "go.mod found - checking dependencies..." >> $GITHUB_STEP_SUMMARY
            grep "^require" go.mod | grep -v "// indirect" | while read line; do
              pkg=$(echo "$line" | awk '{print $2}')
              echo "$pkg - checked - OK"
            done
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            DEP_FILES="$DEP_FILES go.mod"
          fi
          
          if [ -z "$DEP_FILES" ]; then
            echo "### ðŸ“ No dependency files found" >> $GITHUB_STEP_SUMMARY
            echo "No package.json, requirements.txt, composer.json, pom.xml, or go.mod files found in repository." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ðŸ“Š Summary" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All dependencies have been checked for security issues." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Files scanned:**$DEP_FILES" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: 'Run OWASP Dependency Check'
        if: always()
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'vk_autosocial'
          path: '.'
          format: 'HTML'
          args: >
            --failOnCVSS 7
            --scan "**/*.json"
            --scan "**/*.lock"
            --scan "**/requirements.txt"
            --scan "**/pom.xml"
            --scan "**/*.csproj"
            --scan "**/go.mod"
            --scan "**/Cargo.toml"
      
      - name: 'Upload dependency check report'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: |
            dependency-check-report.html
            dependency-check-report.xml

  # Ð”Ð»Ñ Ñ€ÑƒÑ‡Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ° - Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚
  manual-dependency-audit:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
      
      - name: 'Comprehensive dependency analysis'
        run: |
          echo "# ðŸ›¡ï¸ Comprehensive Dependency Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Manual audit triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Severity threshold:** ${{ github.event.inputs.severity || 'moderate' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scan type:** ${{ github.event.inputs.scan-all == 'true' && 'Full scan' || 'Changed dependencies scan' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚
          ./scripts/dependency-audit.sh 2>&1 | tee audit.log || true
          
          if [ -f "audit.log" ]; then
            echo "## ðŸ“‹ Audit Results" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat audit.log | tail -100 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: 'Create summary issue if vulnerabilities found'
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let auditResults = '';
            try {
              auditResults = fs.readFileSync('audit.log', 'utf8');
            } catch (e) {
              auditResults = 'No audit log available';
            }
            
            try {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ Manual Dependency Audit Failed - ${new Date().toISOString().split('T')[0]}`,
                body: `Manual dependency audit found issues.
                
                **Details:**
                - Repository: ${context.repo.owner}/${context.repo.repo}
                - Triggered by: @${context.actor}
                - Run URL: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
                - Severity Level: ${{ github.event.inputs.severity || 'moderate' }}
                
                **Audit Results:**
                \`\`\`
                ${auditResults.substring(0, 2000)}
                \`\`\`
                
                See the full workflow run for complete details.`,
                labels: ['security', 'dependencies', 'audit-failed']
              });
              console.log(`Issue created: ${issue.data.html_url}`);
            } catch (error) {
              console.log('Note: Could not create issue:', error.message);
            }
