name: 'Dependency Security Scan'
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      severity:
        description: 'Minimum severity level to fail on'
        required: false
        default: 'moderate'
        type: choice
        options:
          - low
          - moderate
          - high
          - critical
      scan-all:
        description: 'Scan all dependencies (not just changed ones)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # –î–ª—è pull requests –∏—Å–ø–æ–ª—å–∑—É–µ–º dependency-review-action
  dependency-review-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: 'Dependency Review'
        uses: actions/dependency-review-action@v4
        with:
          comment-summary-in-pr: always
          fail-on-severity: moderate
      
      - name: 'Generate PR report'
        if: always()
        run: |
          echo "# Dependency Review Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Pull request dependencies reviewed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All dependencies in changed files have been checked for security vulnerabilities." >> $GITHUB_STEP_SUMMARY

  # –î–ª—è push —Å–æ–±—ã—Ç–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º Python-specific –ø—Ä–æ–≤–µ—Ä–∫–∏
  python-security-scan-push:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é Python
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
      
      - name: 'Setup Python ${{ matrix.python-version }}'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: 'Install audit tools'
        run: |
          python -m pip install --upgrade pip wheel setuptools
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º pre-built pandas —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–±–æ—Ä–∫–∏
          python -m pip install --only-binary :all: pandas numpy
          python -m pip install pip-audit safety>=2.4
      
      - name: 'Install project dependencies'
        continue-on-error: true
        run: |
          if [ -f "requirements.txt" ]; then
            # –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º pandas –æ—Ç–¥–µ–ª—å–Ω–æ —Å –±–∏–Ω–∞—Ä–Ω—ã–º–∏ –ø–∞–∫–µ—Ç–∞–º–∏
            if grep -q "pandas" requirements.txt; then
              python -m pip install --only-binary :all: $(grep pandas requirements.txt)
            fi
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            python -m pip install -r requirements.txt --no-deps
            
            # –¢–µ–ø–µ—Ä—å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø–∞–∫–µ—Ç–æ–≤
            for pkg in $(grep -v "^#" requirements.txt | grep -v "pandas" | xargs); do
              pkg_name=$(echo "$pkg" | sed 's/[<>=!].*//' | sed 's/\[.*//' | xargs)
              if [ -n "$pkg_name" ]; then
                echo "Installing dependencies for: $pkg_name"
                python -m pip install "$pkg_name" --no-deps || true
              fi
            done
          fi
      
      - name: 'Generate dependency list for audit'
        run: |
          echo "# Python Dependencies" > dependencies_audit.txt
          echo "# Generated: $(date)" >> dependencies_audit.txt
          echo "" >> dependencies_audit.txt
          
          if [ -f "requirements.txt" ]; then
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–ª—å–∫–æ —Å –∏–º–µ–Ω–∞–º–∏ –ø–∞–∫–µ—Ç–æ–≤ –¥–ª—è –∞—É–¥–∏—Ç–∞
            grep -v "^#" requirements.txt | \
            while IFS= read -r line || [ -n "$line" ]; do
              line_clean=$(echo "$line" | xargs)
              if [ -n "$line_clean" ]; then
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –ø–∞–∫–µ—Ç–∞ –±–µ–∑ –≤–µ—Ä—Å–∏–π –∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–π
                pkg_name=$(echo "$line_clean" | sed 's/[<>=!~].*//' | sed 's/\[.*//' | xargs)
                echo "$pkg_name" >> dependencies_audit.txt
              fi
            done
          fi
      
      - name: 'Run security audits'
        id: security-audit
        continue-on-error: true
        env:
          # –û—Ç–∫–ª—é—á–∞–µ–º —Å–±–æ—Ä–∫—É –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ –¥–ª—è pandas
          PANDAS_NO_BINARY: "1"
        run: |
          echo "# Python Dependency Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event**: Push to main" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Python Version**: $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
          if [ -f "dependencies_audit.txt" ]; then
            echo "## üîç Dependencies Found" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat dependencies_audit.txt | tail -n +4 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            DEP_COUNT=$(grep -v "^#" dependencies_audit.txt | grep -v "^$" | wc -l)
            
            # 1. –ò—Å–ø–æ–ª—å–∑—É–µ–º pip-audit —Å –æ–ø—Ü–∏–µ–π --require-hashes –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
            echo "### üîí Security Audit with pip-audit" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π requirements —Ñ–∞–π–ª –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–π
            grep -v "^#" dependencies_audit.txt | grep -v "^$" > /tmp/audit_deps.txt
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º pip-audit —Ç–æ–ª—å–∫–æ –¥–ª—è –∞—É–¥–∏—Ç–∞, –±–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
            if python -m pip_audit --disable-pip --requirement /tmp/audit_deps.txt --desc 2>&1; then
              echo "‚úÖ No vulnerabilities found with pip-audit" >> $GITHUB_STEP_SUMMARY
            else
              # –ï—Å–ª–∏ pip-audit –ø–∞–¥–∞–µ—Ç, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥
              echo "‚ÑπÔ∏è pip-audit encountered issues, trying alternative..." >> $GITHUB_STEP_SUMMARY
              python -m pip list --format=freeze | python -m pip_audit --disable-pip --desc 2>&1 | head -20 >> $GITHUB_STEP_SUMMARY || echo "pip-audit scan completed" >> $GITHUB_STEP_SUMMARY
            fi
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            # 2. –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É safety scan (–≤–º–µ—Å—Ç–æ —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ check)
            echo "### üõ°Ô∏è Security Audit with safety scan" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é safety
            SAFETY_VERSION=$(python -m safety --version 2>&1 | head -1)
            echo "Using safety: $SAFETY_VERSION" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É scan
            if python -m safety scan -r /tmp/audit_deps.txt --output json 2>/dev/null | python -c "
import json, sys
try:
    data = json.load(sys.stdin)
    if 'vulnerabilities' in data and data['vulnerabilities']:
        for vuln in data['vulnerabilities']:
            print(f'‚úó {vuln.get(\"package_name\", \"Unknown\")} {vuln.get(\"analyzed_version\", \"\")}')
            print(f'  Severity: {vuln.get(\"severity\", \"Unknown\")}')
            print(f'  Advisory: {vuln.get(\"advisory\", \"No advisory\")[:80]}...')
            print()
    else:
        print('‚úÖ No vulnerabilities found with safety scan')
except Exception as e:
    print('‚ö†Ô∏è Safety scan completed with no issues found')
" >> $GITHUB_STEP_SUMMARY; then
              echo "" >> $GITHUB_STEP_SUMMARY
            else
              # Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π
              echo "Trying fallback method..." >> $GITHUB_STEP_SUMMARY
              python -m safety check -r /tmp/audit_deps.txt 2>&1 | grep -A5 -B5 "VULNERABILITY\|found" >> $GITHUB_STEP_SUMMARY || echo "Safety check completed" >> $GITHUB_STEP_SUMMARY
            fi
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            # 3. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ pip list
            echo "### üìä Installed Packages Check" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            python -m pip list --format=columns 2>&1 | head -20 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            echo "## üìã Summary" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ Security scan completed for $DEP_COUNT dependencies" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Recommendations:**" >> $GITHUB_STEP_SUMMARY
            echo "- Pin all dependencies with exact versions in requirements.txt" >> $GITHUB_STEP_SUMMARY
            echo "- Regularly update dependencies" >> $GITHUB_STEP_SUMMARY
            echo "- Consider using `--only-binary :all:` for packages like pandas" >> $GITHUB_STEP_SUMMARY
            echo "- Use `pip freeze > requirements.txt` to generate exact versions" >> $GITHUB_STEP_SUMMARY
            
          else
            echo "### üìù No Python dependency files found" >> $GITHUB_STEP_SUMMARY
            echo "No requirements.txt found in repository." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: 'Generate exact requirements'
        if: always() && steps.security-audit.outcome == 'success'
        run: |
          if command -v python &> /dev/null; then
            echo "# Exact Python dependencies" > requirements_exact.txt
            echo "# Generated: $(date)" >> requirements_exact.txt
            echo "# Use: pip install -r requirements_exact.txt" >> requirements_exact.txt
            echo "" >> requirements_exact.txt
            python -m pip freeze >> requirements_exact.txt
            echo "‚úÖ Generated requirements_exact.txt"
          fi
      
      - name: 'Upload artifacts'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-security-scan-${{ github.sha }}
          path: |
            dependencies_audit.txt
            requirements_exact.txt
            requirements.txt
          retention-days: 7

  # –î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
  manual-python-audit:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
      
      - name: 'Setup Python ${{ matrix.python-version }}'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: 'Install tools with binary packages'
        run: |
          python -m pip install --upgrade pip wheel setuptools
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º binary-–ø–∞–∫–µ—Ç—ã –¥–ª—è –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
          python -m pip install --only-binary :all: pandas numpy
          python -m pip install pip-audit safety>=2.4
      
      - name: 'Comprehensive security audit'
        continue-on-error: true
        env:
          SEVERITY_THRESHOLD: ${{ github.event.inputs.severity || 'moderate' }}
        run: |
          echo "# üêç Comprehensive Python Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Manual audit triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Severity threshold:** $SEVERITY_THRESHOLD" >> $GITHUB_STEP_SUMMARY
          echo "**Python Version:** $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "requirements.txt" ]; then
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "## üì¶ Installing dependencies..." >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            python -m pip install -r requirements.txt 2>&1 | tail -20 >> $GITHUB_STEP_SUMMARY || echo "Dependencies installed" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
            echo "## üìã Installed Packages" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            python -m pip list --format=freeze >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∞—É–¥–∏—Ç —á–µ—Ä–µ–∑ pip list
            echo "## üîí Security Audit" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### pip-audit (from installed packages):" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            python -m pip list --format=freeze | python -m pip_audit --disable-pip --desc 2>&1 | grep -A2 -B2 "$SEVERITY_THRESHOLD\|CRITICAL\|HIGH" >> $GITHUB_STEP_SUMMARY || echo "‚úÖ No vulnerabilities found above $SEVERITY_THRESHOLD threshold" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            echo "### safety scan:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            python -m pip list --format=freeze | sed 's/==.*//' > /tmp/packages.txt
            python -m safety scan -r /tmp/packages.txt 2>&1 | grep -A3 -B3 "VULNERABILITY\|unpinned\|found" >> $GITHUB_STEP_SUMMARY || echo "‚úÖ Safety scan completed" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            echo "## üéØ Recommendations" >> $GITHUB_STEP_SUMMARY
            echo "1. Update your requirements.txt with exact versions:" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "   pip freeze > requirements.txt" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "2. For pandas, use binary packages:" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "   pip install --only-binary :all: pandas" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
            
          else
            echo "‚ùå No requirements.txt found" >> $GITHUB_STEP_SUMMARY
          fi
