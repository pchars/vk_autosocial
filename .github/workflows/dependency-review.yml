name: 'Python Dependency Security Scan'
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  security-scan:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install tools
        run: |
          python -m pip install --upgrade pip wheel setuptools
          python -m pip install pip-audit safety>=2.4
      
      - name: Install project dependencies
        continue-on-error: true
        run: |
          if [ -f "requirements.txt" ]; then
            python -m pip install -r requirements.txt
          else
            echo "No requirements.txt found, installing basic dependencies"
            python -m pip install pandas numpy
          fi
      
      - name: Generate dependency list
        id: deps
        run: |
          # Создаем requirements.txt из установленных пакетов
          python -m pip freeze > /tmp/requirements_freeze.txt
          PACKAGE_COUNT=$(wc -l < /tmp/requirements_freeze.txt || echo "0")
          echo "PACKAGE_COUNT=$PACKAGE_COUNT" >> $GITHUB_OUTPUT
          echo "Found $PACKAGE_COUNT packages to scan"
      
      - name: Run pip-audit scan
        if: steps.deps.outputs.PACKAGE_COUNT > 0
        id: pip-audit
        continue-on-error: true
        run: |
          echo "## pip-audit scan (severity: low+):" > /tmp/pip_audit_result.txt
          echo '```' >> /tmp/pip_audit_result.txt
          # Исправлено: используем только файл без аргумента -r
          python -m pip_audit /tmp/requirements_freeze.txt --desc --severity low 2>&1 | tee -a /tmp/pip_audit_result.txt || true
          echo '```' >> /tmp/pip_audit_result.txt
      
      - name: Run safety scan
        if: steps.deps.outputs.PACKAGE_COUNT > 0
        id: safety
        continue-on-error: true
        run: |
          echo "## Safety scan:" > /tmp/safety_result.txt
          echo '```' >> /tmp/safety_result.txt
          # Исправлено: используем правильную команду scan вместо check
          python -m safety scan /tmp/requirements_freeze.txt --json 2>/dev/null | python -c "import json,sys;try:d=json.load(sys.stdin);'scanned_packages'in d and print(f'Scanned {len(d[\"scanned_packages\"])} packages');v=d.get('vulnerabilities',[]);print(f'Found {len(v)} vulnerabilities:')if v else print('✅ No vulnerabilities found');[print(f'✗ {i.get(\"package_name\",\"?\")} {i.get(\"analyzed_version\",\"?\")}\\n  Severity: {i.get(\"severity\",\"?\")}\\n  CVE: {i.get(\"CVE\") or i.get(\"vulnerability_id\",\"?\")}\\n')for i in v];exit(0)except Exception as e:print(f'Error parsing safety results: {e}\\n⚠️ Safety scan completed with warnings')" 2>&1 | tee -a /tmp/safety_result.txt || echo "⚠️ Safety scan failed" >> /tmp/safety_result.txt
          echo '```' >> /tmp/safety_result.txt
      
      - name: Generate security report
        if: always()
        run: |
          echo "# Python Dependency Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Python Version**: $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.deps.outputs.PACKAGE_COUNT }}" -gt "0" ]; then
            echo "## Found ${{ steps.deps.outputs.PACKAGE_COUNT }} packages" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Add pip-audit results if available
            if [ -f "/tmp/pip_audit_result.txt" ]; then
              cat /tmp/pip_audit_result.txt >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Add safety results if available
            if [ -f "/tmp/safety_result.txt" ]; then
              cat /tmp/safety_result.txt >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "## Summary" >> $GITHUB_STEP_SUMMARY
            echo "Scanned ${{ steps.deps.outputs.PACKAGE_COUNT }} packages for security vulnerabilities." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Recommendations:**" >> $GITHUB_STEP_SUMMARY
            echo "- Update vulnerable packages to their latest secure versions" >> $GITHUB_STEP_SUMMARY
            echo "- Regularly run security scans" >> $GITHUB_STEP_SUMMARY
            echo "- Review and fix reported vulnerabilities" >> $GITHUB_STEP_SUMMARY
            echo "- Consider using \`pip-audit\` and \`safety\` in your local development workflow" >> $GITHUB_STEP_SUMMARY
            
            # Check for specific vulnerabilities
            if [ -f "/tmp/safety_result.txt" ] && grep -q "vulnerabilities" /tmp/safety_result.txt; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**⚠️ Security Alert**" >> $GITHUB_STEP_SUMMARY
              echo "Some dependencies have known security vulnerabilities. Please review the report above." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## No Python packages found to scan." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Make sure your project has a \`requirements.txt\` file or installs dependencies via \`setup.py\`/\`pyproject.toml\`." >> $GITHUB_STEP_SUMMARY
          fi
