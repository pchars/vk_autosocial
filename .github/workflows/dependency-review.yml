name: 'Dependency Security Scan'
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      scan-all:
        description: 'Scan all dependencies (not just changed ones)'
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  dependency-review-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: 'Dependency Review'
        uses: actions/dependency-review-action@v4
        with:
          comment-summary-in-pr: always
          fail-on-severity: low

  python-security-scan:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
      
      - name: 'Setup Python ${{ matrix.python-version }}'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: 'Install tools'
        run: |
          python -m pip install --upgrade pip wheel setuptools
          python -m pip install --only-binary :all: pandas numpy
          python -m pip install pip-audit safety>=2.4
      
      - name: 'Install project dependencies'
        continue-on-error: true
        run: |
          if [ -f "requirements.txt" ]; then
            python -m pip install -r requirements.txt
          fi
      
      - name: 'Run security audits'
        id: security-audit
        continue-on-error: true
        run: |
          echo "# Python Dependency Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Python Version**: $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          python -m pip list --format=freeze > /tmp/installed_packages.txt
          PACKAGE_COUNT=$(grep -c "==" /tmp/installed_packages.txt || echo "0")
          
          echo "## ðŸ“¦ Found $PACKAGE_COUNT packages" >> $GITHUB_STEP_SUMMARY
          
          if [ "$PACKAGE_COUNT" -gt 0 ]; then
            echo "### pip-audit scan (severity: low+):" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            python -m pip_audit --disable-pip -r /tmp/installed_packages.txt --desc --severity low 2>&1 >> $GITHUB_STEP_SUMMARY || echo "pip-audit completed" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            echo "### safety scan:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            # Create Python script for safety output parsing
            cat > /tmp/parse_safety.py << 'EOF'
import json
import sys

try:
    import subprocess
    result = subprocess.run(
        ['python', '-m', 'safety', 'scan', '-r', '/tmp/installed_packages.txt', '--json'],
        capture_output=True,
        text=True
    )
    
    if result.returncode == 0 or result.stdout:
        try:
            data = json.loads(result.stdout)
            if 'vulnerabilities' in data:
                vulns = data['vulnerabilities']
                if vulns:
                    for v in vulns:
                        print(f"âœ— {v.get('package_name', '?')} {v.get('analyzed_version', '?')}")
                        print(f"  Severity: {v.get('severity', '?')}")
                        cve = v.get('CVE') or v.get('vulnerability_id', '?')
                        print(f"  CVE: {cve}")
                else:
                    print("âœ… No vulnerabilities found")
            else:
                print("âœ… Safety scan completed")
        except json.JSONDecodeError:
            print("âš ï¸ Safety scan completed (no JSON output)")
    else:
        print("âš ï¸ Safety command failed")
        
except Exception as e:
    print(f"âš ï¸ Error during safety scan: {str(e)}")
EOF
            
            python /tmp/parse_safety.py >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            echo "## ðŸ“‹ Summary" >> $GITHUB_STEP_SUMMARY
            echo "Scanned $PACKAGE_COUNT packages for security vulnerabilities." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Recommendations:**" >> $GITHUB_STEP_SUMMARY
            echo "- Update requirements.txt with exact versions: \`pip freeze > requirements.txt\`" >> $GITHUB_STEP_SUMMARY
            echo "- Regularly run security scans" >> $GITHUB_STEP_SUMMARY
            echo "- Review and fix reported vulnerabilities" >> $GITHUB_STEP_SUMMARY
          else
            echo "No Python packages found to scan." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: 'Generate exact requirements'
        if: always()
        run: |
          if command -v python &> /dev/null && [ -f "requirements.txt" ]; then
            python -m pip freeze > requirements_exact.txt
            echo "Generated requirements_exact.txt"
          fi
      
      - name: 'Upload artifacts'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-security-scan-${{ github.sha }}
          path: |
            requirements_exact.txt
            requirements.txt
          retention-days: 7
