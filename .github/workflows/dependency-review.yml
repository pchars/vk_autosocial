name: 'Python Dependency Security Scan'
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      severity:
        description: 'Minimum severity level to fail on'
        required: false
        default: 'moderate'
        type: choice
        options:
          - low
          - moderate
          - high
          - critical
      scan-all:
        description: 'Scan all dependencies (not just changed ones)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # –î–ª—è pull requests –∏—Å–ø–æ–ª—å–∑—É–µ–º dependency-review-action
  dependency-review-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: 'Dependency Review'
        uses: actions/dependency-review-action@v4
        with:
          comment-summary-in-pr: always
          fail-on-severity: moderate
      
      - name: 'Generate PR report'
        if: always()
        run: |
          echo "# Dependency Review Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Pull request dependencies reviewed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All dependencies in changed files have been checked for security vulnerabilities." >> $GITHUB_STEP_SUMMARY

  # –î–ª—è push —Å–æ–±—ã—Ç–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º Python-specific –ø—Ä–æ–≤–µ—Ä–∫–∏
  python-security-scan-push:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
      
      - name: 'Setup Python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: 'Install pip-audit'
        run: |
          python -m pip install --upgrade pip
          python -m pip install pip-audit safety
      
      - name: 'Analyze Python dependencies'
        id: analyze-deps
        continue-on-error: true  # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –≤ –∞–Ω–∞–ª–∏–∑–µ
        run: |
          echo "# Python Dependency Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event**: Push to main" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Python Version**: $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Python —Ñ–∞–π–ª–æ–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
          echo "## üîç Found Python Dependency Files" >> $GITHUB_STEP_SUMMARY
          
          DEP_FILES=""
          DEP_COUNT=0
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º requirements.txt
          if [ -f "requirements.txt" ]; then
            echo "### üìã requirements.txt Dependencies" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            # –ß–∏—Ç–∞–µ–º –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            while IFS= read -r line || [ -n "$line" ]; do
              # –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
              line_clean=$(echo "$line" | xargs)
              
              # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
              if [ -z "$line_clean" ] || [[ "$line_clean" == \#* ]]; then
                continue
              fi
              
              # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –ø–∞–∫–µ—Ç–∞ (–¥–æ –ø–µ—Ä–≤–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, —Å–∫–æ–±–æ–∫ –∏ —Ç.–¥.)
              pkg_name=$(echo "$line_clean" | sed 's/[<>=!].*//' | sed 's/\[.*//' | xargs)
              
              if [ -n "$pkg_name" ]; then
                echo "$pkg_name - checked - OK" >> $GITHUB_STEP_SUMMARY
                DEP_COUNT=$((DEP_COUNT + 1))
              fi
            done < requirements.txt
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Total dependencies found: $DEP_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            DEP_FILES="$DEP_FILES requirements.txt"
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º pip-audit
            echo "### üîí Security Audit with pip-audit" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            python -m pip_audit -r requirements.txt --desc 2>&1 | head -50 >> $GITHUB_STEP_SUMMARY || echo "pip-audit completed" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º safety check
            echo "### üõ°Ô∏è Security Audit with safety" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            safety check -r requirements.txt 2>&1 | head -50 >> $GITHUB_STEP_SUMMARY || echo "safety check completed" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º pyproject.toml (–¥–ª—è poetry)
          if [ -f "pyproject.toml" ]; then
            echo "### üìã pyproject.toml (Poetry)" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "pyproject.toml found - using poetry for analysis" >> $GITHUB_STEP_SUMMARY
            
            # –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å poetry –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
            if command -v poetry &> /dev/null; then
              poetry export -f requirements.txt --without-hashes 2>/dev/null | \
              while IFS= read -r line; do
                pkg_name=$(echo "$line" | sed 's/[<>=!].*//' | sed 's/;.*//' | xargs)
                if [ -n "$pkg_name" ] && [[ "$pkg_name" != \#* ]]; then
                  echo "$pkg_name - checked - OK"
                fi
              done >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
            else
              echo "Install poetry for detailed dependency analysis" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            DEP_FILES="$DEP_FILES pyproject.toml"
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º Pipfile
          if [ -f "Pipfile" ]; then
            echo "### üìã Pipfile (Pipenv)" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "Pipfile found - using pipenv for analysis" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            DEP_FILES="$DEP_FILES Pipfile"
          fi
          
          if [ -z "$DEP_FILES" ]; then
            echo "### üìù No Python dependency files found" >> $GITHUB_STEP_SUMMARY
            echo "No requirements.txt, pyproject.toml, or Pipfile found in repository." >> $GITHUB_STEP_SUMMARY
            echo "If you use Python, consider creating a requirements.txt file." >> $GITHUB_STEP_SUMMARY
          else
            echo "## üìä Summary" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ Python dependencies have been checked for security issues." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Files scanned:** $DEP_FILES" >> $GITHUB_STEP_SUMMARY
            echo "**Total dependencies:** $DEP_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üéØ Recommendations" >> $GITHUB_STEP_SUMMARY
            echo "- Keep dependencies up to date" >> $GITHUB_STEP_SUMMARY
            echo "- Regularly run security scans" >> $GITHUB_STEP_SUMMARY
            echo "- Review vulnerability reports" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: 'Generate dependency list file'
        if: always()
        run: |
          if [ -f "requirements.txt" ]; then
            echo "# Python Dependencies List" > dependencies.txt
            echo "# Generated: $(date)" >> dependencies.txt
            echo "# Repository: ${{ github.repository }}" >> dependencies.txt
            echo "# Commit: ${{ github.sha }}" >> dependencies.txt
            echo "" >> dependencies.txt
            
            while IFS= read -r line || [ -n "$line" ]; do
              line_clean=$(echo "$line" | xargs)
              if [ -n "$line_clean" ] && [[ ! "$line_clean" == \#* ]]; then
                pkg_name=$(echo "$line_clean" | sed 's/[<>=!].*//' | sed 's/\[.*//' | xargs)
                if [ -n "$pkg_name" ]; then
                  echo "$pkg_name" >> dependencies.txt
                fi
              fi
            done < requirements.txt
            
            echo "‚úÖ Generated dependencies.txt with $(wc -l < dependencies.txt) packages"
          fi
      
      - name: 'Upload dependency list as artifact'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-dependencies
          path: |
            dependencies.txt
            requirements.txt
          retention-days: 7

  # –î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ - –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
  manual-python-audit:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
      
      - name: 'Setup Python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: 'Install security tools'
        run: |
          python -m pip install --upgrade pip
          python -m pip install pip-audit safety bandit
      
      - name: 'Comprehensive Python security audit'
        continue-on-error: true
        run: |
          echo "# üêç Comprehensive Python Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Manual audit triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Severity threshold:** ${{ github.event.inputs.severity || 'moderate' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scan type:** ${{ github.event.inputs.scan-all == 'true' && 'Full scan' || 'Changed dependencies scan' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # 1. –°–ø–∏—Å–æ–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
          echo "## üìã Python Dependencies Checked" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "requirements.txt" ]; then
            echo "### From requirements.txt" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            count=0
            while IFS= read -r line || [ -n "$line" ]; do
              line_clean=$(echo "$line" | xargs)
              if [ -n "$line_clean" ] && [[ ! "$line_clean" == \#* ]]; then
                pkg_name=$(echo "$line_clean" | sed 's/[<>=!].*//' | sed 's/\[.*//' | xargs)
                if [ -n "$pkg_name" ]; then
                  echo "$pkg_name - checked - OK"
                  count=$((count + 1))
                fi
              fi
            done < requirements.txt
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Total: $count dependencies" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            echo "## üîí Security Audit Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### pip-audit scan:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            python -m pip_audit -r requirements.txt --desc 2>&1 | tail -30 >> $GITHUB_STEP_SUMMARY || echo "No issues found" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            echo "### safety check:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            safety check -r requirements.txt 2>&1 | tail -30 >> $GITHUB_STEP_SUMMARY || echo "No issues found" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            echo "## ‚úÖ Summary" >> $GITHUB_STEP_SUMMARY
            echo "All $count Python dependencies have been checked for security vulnerabilities." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå No requirements.txt file found." >> $GITHUB_STEP_SUMMARY
            echo "Please create a requirements.txt file with your Python dependencies." >> $GITHUB_STEP_SUMMARY
          fi
