# Dependency Review Action
#
# This Action will scan dependency manifest files that change as part of a Pull Request,
# surfacing known-vulnerable versions of the packages declared or updated in the PR.
# Once installed, if the workflow run is marked as required, PRs introducing known-vulnerable
# packages will be blocked from merging.
#
# Source repository: https://github.com/actions/dependency-review-action
# Public documentation: https://docs.github.com/en/code-security/supply-chain-security/understanding-your-software-supply-chain/about-dependency-review#dependency-review-enforcement
name: 'Dependency review'
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      severity:
        description: 'Minimum severity level to fail on'
        required: false
        default: 'moderate'
        type: choice
        options:
          - low
          - moderate
          - high
          - critical
      scan-all:
        description: 'Scan all dependencies (not just changed ones)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  dependency-review:
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è pull_request —Å–æ–±—ã—Ç–∏–π
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: 'Dependency Review'
        uses: actions/dependency-review-action@v4
        with:
          comment-summary-in-pr: always
          fail-on-severity: moderate
  
  manual-dependency-check:
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
      
      - name: 'Install dependencies'
        run: |
          # –ó–¥–µ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
          # –ù–∞–ø—Ä–∏–º–µ—Ä: npm ci, pip install -r requirements.txt –∏ —Ç.–¥.
          echo "Install dependencies based on your project type"
      
      - name: 'Run security scan (example with npm audit)'
        if: github.event.inputs.scan-all
        run: |
          # –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è –≤–∞—à–µ–≥–æ —Å—Ç–µ–∫–∞
          # –ù–∞–ø—Ä–∏–º–µ—Ä –¥–ª—è Node.js:
          # npm audit --audit-level=${{ github.event.inputs.severity || 'moderate' }}
          # –∏–ª–∏ –¥–ª—è Python:
          # pip-audit
          echo "Run full security scan with severity: ${{ github.event.inputs.severity || 'moderate' }}"
      
      - name: 'Check changed dependencies only'
        if: github.event.inputs.scan-all == false
        run: |
          # –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è
          # —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∫–æ–º–º–∏—Ç–æ–º
          echo "Checking changed dependencies"
      
      - name: 'Create Issue on failure'
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            try {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'üö® Manual Dependency Check Failed',
                body: `Manual dependency check found issues.
                
                **Details:**
                - Repository: ${context.repo.owner}/${context.repo.repo}
                - Workflow: ${context.workflow}
                - Run ID: ${context.runId}
                - Run URL: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
                - Severity Level: ${{ github.event.inputs.severity || 'moderate' }}
                
                Please check the workflow run for details.`,
                labels: ['security', 'dependencies', 'ci-failed']
              });
              console.log(`Issue created: ${issue.data.html_url}`);
            } catch (error) {
              console.log('Could not create issue:', error.message);
              console.log('Consider adding issues:write permission');
            }
